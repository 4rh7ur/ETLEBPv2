---
title: "analise_algoritmo"
output: 
  html_document:
    number_sections: true
    toc: true
    toc_float: true
    
    


---

# Identificação dos Projetos das Bases Brutas nas Base Final
```{r, include = FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
library(DBI)
library(dplyr)
library(ETLEBP)
library(RSQLite)
library(tidyverse)
# Importando os dados sqlite
filename <- here::here("data/DB_EIP/EIP_20210415.db")

con <- DBI::dbConnect(RSQLite::SQLite(),
                      ":memory:",
                      dbname = filename)

# Importando as tabelas do SQlite da INOVA-E
tbl_dm_agente_empresa <- dbReadTable(con,"dm_agente_empresa")
tbl_dm_categoria <- dbReadTable(con,"dm_categoria")
tbl_dm_formentador <- dbReadTable(con,"dm_formentador")
tbl_dm_mod_finan <- dbReadTable(con,"dm_mod_finan")
tbl_dm_nat_disp <- dbReadTable(con,"dm_nat_disp")
tbl_dm_projeto <- DBI::dbReadTable(con,"dm_projeto")
tbl_ft_dispendio <- dbReadTable(con,"ft_dispendio")

# Selecionando os atributos de interesse
dispendios_sel <- tbl_ft_dispendio %>%  select(id_item,id_formnt, vlr, id_cat2) %>%
                    group_by(id_item,id_formnt, id_cat2) %>% summarise(vlr = sum(vlr)) 

# Enriquecendo a tabela com as categorias de IEA
dispendios_sel <- left_join(dispendios_sel, tbl_dm_categoria,
          by = c("id_cat2" = "id"))
# Selecionando as categorias de interesse pós enriquecimento
dispendios_sel <- dispendios_sel %>% select(id_item,id_formnt, vlr,cat2)

# Dataset utilizado para a analise
dm_proj_dispendio <- merge(tbl_dm_projeto, dispendios_sel, all.x = T)  %>% unique()
options(scipen = 999)
```

O procedimento seguido para verificação dos casos foi: 

* 1. Importamos as tabelas da INOVA-E; 

* 2. Enriquecemos tabela de dispendios com os digitos 2 de classificação, e enriquecemos a tabela que detalha projetos com as
categorias de IEA e a soma do financiamento do projeto; 

* 3. Filtramos os dados por fomentador e seguimos a ánalise por fomentador dos dado;

* 4. Fazemos um enriquecimento entre tabela que contém casos oriundos da INOVA-E e tabela com os projetos de energia da base de dados intermediárias; 

* 5. Filtramos os dados com valores ausentes para os projetos de energia da base tratada;

* 6. Checamos se os casos que existem na plataforma INOVA-E não existem nos datasets sem tratamento da atual carga e se não existem nos datasets utilizados em 2019.

Com o objetivo de maximizar a clareza, quando nos refirirmos aos datasets da INOVA-E temos como referência os casso que já foram validados e estão carregados no SQLite. Quando nos referimos a datasets intermediários trata-se dos dados que receberam o tratamento pela função ETLEBP::cria_base_intermediaria. Quando nos referimos a datasets brutos, trata-se dos dados que utilizamos para produzir os datasets intermediários, mas sem nenhum tratamento ou filtro. Quando nos referimos a datasets originais falamos dos datasets utilizados para fazer a 1° carga no SQLite.

## Aneel

Para a fonte ANEEL são utilizados 2 datasets, ambos disponíveis no repositório da fonte. o 1° PD Busca Textual que contém as informações de financiamento dos projetos de energia, e o 2° 5.PD RF EQUIPE, que é usado para enriquecimento do 1°, adicionando as informações de entidade vinculada e de onde UF da projeto. Dentro da etapa de tratamento são feitos apenas 2 filtros. Removemos todos os projetos com duração prevista inferior a 2013/01/01 e com valores de financiamento omissos, ou seja com valores de financiamento não disponíveis no dataset.

Para os projetos da aneel temos o atributo id_item igual tanto na base de referência como na base bruta, e portanto é ele usado como digito identificador.

```{r}
#Filtrando os casos do Fomentador alvo
dm_aneel <- dm_proj_dispendio %>% filter(id_formnt == 5)

#Importando os dataset tratado
aneel <- cria_base_intermediaria_aneel()

#Removendo o string identificador da base no atributo dos projetos
aneel <- aneel %>% mutate(id = str_remove(id, "ANEEL-"))

#Importando a base de dados bruta
origem_processos = here::here("data/SGPED_BI/PD Busca Textual.csv")

aneel_org  <- readr::read_delim(origem_processos,
                        ";", escape_double = FALSE, locale = readr::locale(encoding = "latin1"),
                        trim_ws = TRUE) %>%
    janitor::clean_names()
```

Ao enriquecermos o banco de dados observamos que existem 472 casos que só existem na plataforma inovae e procuramos entender o por que esses dados não existem no dataset intermediário.
```{r, message=TRUE}
#juntamos todos os casos da base dm_aneel e aneel
comparacao <- tidylog::full_join(dm_aneel, aneel, suffix = c("_dm_aneel", "_base_tratada"),
                    by = c("id_item" = "id"), keep = TRUE)
```

Dataset com os projetos de energia que só foram encontrados na INOVA-E.
```{r}
#criamos um dataset com todos os casos que não tem valores na base tratada
sobra_dm_aneel <- comparacao %>% filter(is.na(id))

reactable::reactable(sobra_dm_aneel)
```

Ao compararmos com os dados brutos da carga observamos que alguns dos casos faltantes aparecem 
```{r}
comparacao_org <- tidylog::inner_join(sobra_dm_aneel, aneel_org, 
                                     by = c("id_item" = "cod_proj"))
```
Seguem abaixo os casos identificados que estavam presentes no dataset bruto, observamos que os valores de custo total previsto e custo total realizado estavam com informações faltantes. Nosso script de tratamento exclue projetos de energia sem valores de financiamento.
```{r}
comparacao_org_sel <- comparacao_org %>% select(id_item,
                                                titulo,
                                                cat2,
                          custo_total_previsto,
                          custo_total_realizado,
                          situacao,
                          vlr)

reactable::reactable(comparacao_org_sel)
```

Decidimos então verificar se os casos existem no dataset usado na 1° carga do SQLite. E observamos que nenhum caso existe apenas apenas nos datasets INOVA-E.

```{r}
#checando com os valores dos dados do ebp1

aneel_ebp1 <- readr::read_delim(here::here("analise algoritmo/bases 1 versao ebp/5.ANEELpd.csv"), 
                         delim = ";", escape_double = FALSE, trim_ws = TRUE) %>%
  janitor::clean_names()
```

```{r, message=TRUE}
comparacao_ebp1 <- tidylog::inner_join(sobra_dm_aneel, aneel_ebp1,
                                       by = c("id_item" = "cod_proj")) %>%
                          select(id_item,
                          titulo,
                          cat2,
                          custo_total_previsto,
                          custo_total_realizado,
                          situacao,
                          vlr)
```

Quando verificado com os datasets utilizados na 1° versão da carga do ETL encontramos os valores de financiamento do projeto tais como  vistos no dataset INOVA-E.
```{r}
comparacao_ebp1 <- comparacao_ebp1 %>%
   mutate(custo_total_previsto          = as.numeric(stringr::str_replace_all(
                                           stringr::str_replace_all(custo_total_previsto, "[.$]", ""), "[,]", "." )),
          correto = custo_total_previsto == vlr ) 

reactable::reactable(comparacao_ebp1)
```

Por fim checamos se os casos que estão no dataset INOVA-E também podem ser encontrados no dataset original.

```{r, message=TRUE}
# checando se os casos do SQlite se encontram  no dataset do ebp1
# todos os casos do SQLite estão no banco de dados usado no ebp1
check_aneel_id <- tidylog::full_join(dm_aneel, aneel_ebp1, suffix = c("_dm_aneel", "_base_ebp"),
                    by = c("id_item" = "cod_proj"), keep = TRUE)
```

## ANP

Para fonte ANP é utilizado o dataset "projetos-rt-3-2015", que fora nos disponibilizado pela ANP, o dataset "projetos-rt-3-2015" contém as informações de financiamento de projetos e o dataset anp_agregados_declarados.xlsx - Plan1.csv que contém o valor de financimento agregado por ano para a fonte. Removemos todos os projetos com duração prevista inferior a 2013/01/01 e com valores de financiamento omissos, ou seja com valores de financiamento não disponíveis no dataset.


```{r}
#Filtrando os casos do Fomentador alvo
dm_anp <- dm_proj_dispendio %>% filter(id_formnt == 11)

#Importando os dataset tratado
anp <- cria_base_intermediaria_anp()

#Removendo o string identificador da base no atributo dos projetos
anp <- anp %>% mutate(id = str_remove(id, "ANP-"))

#Importando a base de dados bruta
origem_processos = origem_processos = here::here("data/ANP/projetos-rt-3-2015.csv")

anp_org <-  readr::read_delim(origem_processos,
                         ";", escape_double = FALSE, trim_ws = TRUE) %>%
              janitor::clean_names()

anp_ebp <- readr::read_delim(here::here("analise algoritmo/bases 1 versao ebp/4.anp.csv"), 
    delim = ";", escape_double = FALSE, trim_ws = TRUE, 
    skip = 4) %>% 
    janitor::clean_names()

```

Para os projetos da ANP só existe 1 caso, que é o agregado de todos os projetos de 2016 a 2018 dos financiamentos em PD da Agência. 
Até ano 2018 não existem dados desagregados por projeto. A partir de 2018 utiliza-se a base ANP que possui microdados por projetos. Projetos que terminam depois de 2018, mas começam antes dessa data, serão incluídos na base integrada inova-e. Nesses casos, os valores proporcionais deexecução dos projetos antes de 2018 não serão incluídos. Apenas os valores a partir do ano de 2019 é que serão adicionados a base ANP

Para garantir que os projetos que serão inseridos não tenham valor duplicados, ou valores faltantes o procedimento tomado foi selecionar os casos do dataset intermediário que estão contidos no dataset original e para os atributos gasto_2016, gasto_2017 e gasto_2018, foram zerados o valor de financiamento. Garantindo assim que se o projeto fora financiado de de 2016 a 2020, os valores referentes aos anos de 2016 a 2018 não serão adicionados ao SQLite, já que esse valor já existe no projeto único que contém todos os casos do dataset original.

Observamos que todos os casos que estão contidos no dataset original também estão contidos no dataset bruto.
```{r, message=TRUE}
checagem_anp <- tidylog::full_join(anp_ebp, anp_org,
                                   by =c("no_anp" ="no_anp"),suffix = c("_2019", "_2021")
)
```
Todavia quando checamos se os casos que estavam contidos no dataset original tiveram seus valores de projetos constantes.
```{r}
checagem_anp_vlr <- checagem_anp %>%
  filter(!is.na(valor_clausula_2019)) %>% 
  select(no_anp, valor_clausula_2019, valor_clausula_2021,data_inicio_2019, prazo_2019 = prazo,
         data_inicio_2021, prazo_2021 =prazo_de_execucao_meses) %>% 
  mutate(
      valor_clausula_2019       = as.numeric(stringr::str_replace_all(
                             stringr::str_remove_all(valor_clausula_2019, "[.R$ ]"), "[,]", ".")),
      valor_clausula_2021       = as.numeric(stringr::str_replace_all(
                             stringr::str_remove_all(valor_clausula_2021, "[.R$ ]"), "[,]", ".")),
      data_inicio_2019          = lubridate::dmy(data_inicio_2019),
      prazo_2019     = data_inicio_2019 + months(prazo_2019),
      data_inicio_2021          = lubridate::dmy(data_inicio_2021),
      prazo_2021     = data_inicio_2021 + months(prazo_2021),
      check = valor_clausula_2019 == valor_clausula_2021
      ) %>% arrange(check) %>% 
  select(no_anp, valor_clausula_2019, valor_clausula_2021, check, data_inicio_2019, prazo_2019, data_inicio_2021, prazo_2021)

checagem_anp_vlr %>% reactable::reactable()
```

Observamos que apenas 2 casos tiveram alteração no valor de financiamento do projeto. Portanto a decisão de considerar que o valor de todos os projetos projetos estão no SQLite não deve ser tomada. 

```{r}
checagem_anp_vlr %>% janitor::tabyl(check)
```
E que essa diferença foi na ordem de 1.627.423

```{r}
checagem_anp_vlr %>%
  mutate(diferença = valor_clausula_2021-valor_clausula_2019) %>% 
  summarise(diferença = sum(diferença))
```

Dentro dos projetos de energia que foram classificados nas bases intermediárias encontramos as seguintes classificações de IEA


```{r}
anp %>% select(id,categorias) %>%
  rowwise() %>%
  mutate(categorias_split = str_split(categorias, pattern = ",")) %>%
  ungroup() %>% unnest(categorias_split_un =categorias_split) %>% 
  mutate(categorias_split_un = str_remove_all(categorias_split_un, '\\"'),
         categorias_split_un = str_remove_all(categorias_split_un, ' ')) %>% 
  mutate(categorias_rec = recode(categorias,
                                       `1.1` = "1 Eficiência Energética",
                                       `1.4` = "1 Eficiência Energética",
                                       `2.1` = "2 Energias Fósseis",
                                       `2.2` = "2 Energias Fósseis",
                                       `3.1` = "3 Fontes de Energia Renováveis",
                                       `3.2` = "3 Fontes de Energia Renováveis",
                                       `3.3` = "3 Fontes de Energia Renováveis",
                                       `3.4` = "3 Fontes de Energia Renováveis",
                                       `3.5` = "3 Fontes de Energia Renováveis",
                                       `3.6` = "3 Fontes de Energia Renováveis",
                                       `3.7` = "3 Fontes de Energia Renováveis",
                                       `3.9` = "3 Fontes de Energia Renováveis",
                                       `4.1` = "4 Fissão e Fusão Nuclear",
                                       `5.1` = "5 Hidrogenio e Celulas de Combustível",
                                       `5.2` = "5 Hidrogenio e Celulas de Combustível",
                                       `6.2` = "6 Outras Tecnologias Elétricas e de Armazaenamento",
                                       `6.3` = "6 Outras Tecnologias Elétricas e de Armazaenamento",
                                       `7.1` = "7 Outras Tecnologias Transversais",
                                 "nenhumacategoriaencontrada" = "nenhuma categoria encontrada")) %>% 
  pull(categorias_rec) %>% janitor::tabyl()
```

Na tabela abaixo vemos os resultados quando discriminados por categorias de digito 2.

```{r}
anp %>% select(id,categorias) %>%
  rowwise() %>%
  mutate(categorias_split = str_split(categorias, pattern = ",")) %>%
  ungroup() %>% unnest(categorias_split_un =categorias_split) %>% 
  mutate(categorias_split_un = str_remove_all(categorias_split_un, '\\"'),
         categorias_split_un = str_remove_all(categorias_split_un, ' ')) %>% 
  mutate(categorias_rec = recode(categorias_split_un,
                                       `1.1` = "1.1 Tecnologias de Eficiência Energética Aplicadas a Indústria",
                                       `1.4`= "1.4 Outras Tecnologias de Eficiência Energética",
                                       `2.1` = "2.1 Petróleo e Gás Natural",
                                       `2.2` = "2.2 Carvão Mineral",
                                       `3.1` = "3.1 Energia Solar",
                                       `3.2` = "3.2 Energia Eólica",
                                       `3.3` = "3.3 Energia dos Oceanos",
                                       `3.4` = "3.4 Biocombustíveis",
                                       `3.5` = "3.5 ENergia Geotérmica",
                                       `3.6` = "3.6 Hidroeletricidade",
                                       `3.7` = "3.7 Outras energias Renováveis",
                                       `4.1` = "4.1 Fissão Nuclear",
                                       `5.1` = "5.1 Hidrogenio",
                                       `5.2` = "5.2 Celulas de Combustível",
                                       `6.2` = "6.2 Transmissão e Distribuição",
                                       `6.3` = "6.3 Armazenamento",
                                       `7.1` = "7.1 Análise de Sistemas Energéticos")) %>% 
  pull(categorias_rec) %>% 
  janitor::tabyl()
```

Já quando analisamos sem considerar os projetos que foram classificados em mais de uma categoria de energia encontramos o seguinte resultado. 

```{r}
anp %>%
  filter(categorias %in% c("1.1", "1.2","1.3",
                             "1.4",
                             "2.1","2.2","2.3",
                             "3.1","3.2","3.3",
                             "3.4","3.5","3.6",
                             "3.7",
                             "4.1","4.2",
                             "5.1","5.2",
                             "6.1","6.2","6.3",
                             "7.1","7.2", "nenhuma categoria encontrada")) %>%
  mutate(categorias_rec = recode(categorias,
                                       `1.1` = "1 Eficiência Energética",
                                       `1.4`= "1 Eficiência Energética",
                                       `2.1` = "2 Energias Fósseis",
                                       `2.2` = "2 Energias Fósseis",
                                       `3.1` = "3 Fontes de Energia Renováveis",
                                       `3.2` = "3 Fontes de Energia Renováveis",
                                       `3.3` = "3 Fontes de Energia Renováveis",
                                       `3.4` = "3 Fontes de Energia Renováveis",
                                       `3.5` = "3 Fontes de Energia Renováveis",
                                       `3.6` = "3 Fontes de Energia Renováveis",
                                       `3.7` = "3 Fontes de Energia Renováveis",
                                       `4.1` = "4 Fissão e Fusão Nuclear",
                                       `5.1` = "5 Hidrogenio e Celulas de Combustível",
                                       `5.2` = "5 Hidrogenio e Celulas de Combustível",
                                       `6.2` = "6 Outras Tecnologias Elétricas e de Armazaenamento",
                                       `6.3` = "6 Outras Tecnologias Elétricas e de Armazaenamento",
                                       `7.1` = "7 Outras Tecnologias Transversais")) %>% 
  pull(categorias_rec) %>% 
  janitor::tabyl()
```

Na tabela abaixo vemos os resultados quando discriminados por categorias de digito 2.
```{r}
anp %>%
  filter(categorias %in% c("1.1", "1.2","1.3",
                             "1.4",
                             "2.1","2.2","2.3",
                             "3.1","3.2","3.3",
                             "3.4","3.5","3.6",
                             "3.7",
                             "4.1","4.2",
                             "5.1","5.2",
                             "6.1","6.2","6.3",
                             "7.1","7.2", "nenhuma categoria encontrada")) %>%
  mutate(categorias_rec = recode(categorias,
                                       `1.1` = "1.1 Tecnologias de Eficiência Energética Aplicadas a Indústria",
                                       `1.4`= "1.4 Outras Tecnologias de Eficiência Energética",
                                       `2.1` = "2.1 Petróleo e Gás Natural",
                                       `2.2` = "2.2 Carvão Mineral",
                                       `3.1` = "3.1 Energia Solar",
                                       `3.2` = "3.2 Energia Eólica",
                                       `3.3` = "3.3 Energia dos Oceanos",
                                       `3.4` = "3.4 Biocombustíveis",
                                       `3.5` = "3.5 ENergia Geotérmica",
                                       `3.6` = "3.6 Hidroeletricidade",
                                       `3.7` = "3.7 Outras energias Renováveis",
                                       `4.1` = "4.1 Fissão Nuclear",
                                       `5.1` = "5.1 Hidrogenio",
                                       `5.2` = "5.2 Celulas de Combustível",
                                       `6.2` = "6.2 Transmissão e Distribuição",
                                       `6.3` = "6.3 Armazenamento",
                                       `7.1` = "7.1 Análise de Sistemas Energéticos")) %>% 
  pull(categorias_rec) %>% 
  janitor::tabyl()
```



```{r}
anp_split<- anp %>%
        filter(categorias %in% c("1.1", "1.2","1.3",
                             "1.4",
                             "2.1","2.2","2.3",
                             "3.1","3.2","3.3",
                             "3.4","3.5","3.6",
                             "3.7",
                             "4.1","4.2",
                             "5.1","5.2",
                             "6.1","6.2","6.3",
                             "7.1","7.2", "nenhuma categoria encontrada")) %>%
          group_by(categorias) %>%select(id, titulo_projeto, motor, categorias) %>% 
  slice_sample(n = 5)

reactable::reactable(anp_split)
```

## BNDES

Para essa fonte de dados utilizamos o dataset "naoautomaticas.xlsx", disponibilizado no site da fonte dos dados. Para essa fonte de dados fazemos removemos todos os casos que tem data de conclusão inferior a 01/01/2013, não são projetos de inovação e tem valores ausentes para o campo de valor contratado, que mede o valor do financiamento do projeto.

Para os projetos do BNDES temos 102 casos no dataset INOVA-E. O caso do BNDES tem algumas especificidades, conforme veremos a seguir,  primeira é que não conseguimos recuperar alguns projetos do SQlite no dataset original, a outra é que houve uma alteração nos campos de identificação do projeto que não costam no dataset original. 

Já que o ID dos projetos foi alterado, decidimos fazer a busca pelo título do projeto

```{r}
#Filtrando os casos do Fomentador alvo
#102 casos
dm_bndes <- dm_proj_dispendio %>% filter(id_formnt == 6)

#Importando os dataset tratado
bndes <- cria_base_intermediaria_bndes()

#Removendo o string de identificação da fonte do identificador do projeto
bndes <- bndes %>% mutate(id = str_remove(id, "BNDES-"))


#Importando dataset bruto
origem_processos = here::here("data/BNDES/naoautomaticas.xlsx")

bndes_org <- readxl::read_excel(origem_processos, skip = 4)%>%
           janitor::clean_names()

# Falha quando comparamos por id. 0 Matched Rows
# 102 linhas apenas em dm_bndes
comparacao_bndes_id <- tidylog::full_join(dm_bndes, bndes, suffix = c("_dm_bndes", "_base_tratada"),
                    by = c("id_item" = "id"), keep = TRUE)

```

Ainda assim nós é retornado que existem 97 projetos apenas no SQLite que não podem ser encontrados na base tratada

```{r, message = TRUE}
# 97 linhas apenas em dm_bndes
comparacao_bndes <- tidylog::full_join(dm_bndes, bndes, suffix = c("_dm_bndes", "_base_tratada"),
                    by = c("título" = "titulo_projeto"), keep = TRUE)

```
Os projetos que foram retornados podem ser vistos a seguir

```{r}
#dataset com todos os casos que existem no SQLite da inova-E 
#mas que não tem correspondência na base tratada
sobra_dm_bndes <-  comparacao_bndes %>% filter(is.na(titulo_projeto))

reactable::reactable(sobra_dm_bndes)
```

Ao fazermos a comparação com os datasets brutos do BNDES ainda assim não temos sucesso em fazer correspondência entre o título do projeto no dataset da INOVA-E com o título dos projetos nos datasets brutos. 

```{r}
#utilizando a base bruta

comparacao_bndes_org_id <- tidylog::inner_join(sobra_dm_bndes, bndes_org, 
                                     by = c("id_item" = "numero_do_contrato"))

comparacao_bndes_org <- tidylog::inner_join(sobra_dm_bndes, bndes_org, 
                                     by = c("título" = "descricao_do_projeto"))



```

Ao fazermos uso dos dados que foram utilizados para fazer a primeira carga no projeto não conseguimos encontrar nenhuma correspondência, como pode ser visto abaixo.

```{r, message = TRUE}
# fazendo uso dos dados que foram carregados na fase 1 do projeto

bndes_ebp <- read_delim(here::here("analise algoritmo/bases 1 versao ebp/6.bndes.csv"), 
    delim = ";", escape_double = FALSE, trim_ws = TRUE, 
    skip = 4) %>% janitor::clean_names() %>% 
    mutate(numero_do_contrato = as.character(numero_do_contrato))

comparacao_bndes_ebp_id <- tidylog::inner_join(sobra_dm_bndes, bndes_ebp,
                                       by = c("id_item" = "numero_do_contrato"))

comparacao_bndes_ebp <- tidylog::inner_join(sobra_dm_bndes, bndes_ebp,
                                       by = c("título" = "descricao_do_projeto")) %>%
                          select(título,
                          id_item,
                          numero_do_contrato,
                          cat2,
                          valor_contratado_r,
                          valor_desembolsado_r,
                          situacao_do_contrato,
                          vlr)
```

Ao executar a comparação entre os casos do BNDES no dataset da INOVA-E com os originais não conseguimos encontrar correspondência ao usar o atributo id_item, que mede o código identificador do projeto na fonte.

```{r}

check_bndes_id <- tidylog::full_join(dm_bndes, bndes_ebp, suffix = c("_dm_bndes", "_base_ebp"),
                    by = c("id_item" = "numero_do_contrato"), keep = TRUE)
```

Todavia ao fazer o mesmo procedimento utilizando o atributo título dos 102 projetos de energia, 97 não existem no dataset original. Foram retornados 30 projetos incluindo projetos duplicados.

```{r, message = TRUE}
#Dos 102 projetos encontrados no SQlite 97 não foram encontrados no banco de dados original

check_bndes <- tidylog::full_join(dm_bndes, bndes_ebp, suffix = c("_dm_bndes", "_base_ebp"),
                    by = c("título" = "descricao_do_projeto"), keep = TRUE)
```

Dataset om os casos encontrados no dataset original.

```{r}
reactable::reactable(check_bndes)
```

Todavia após refazermos a análise identificando o por que não conseguimos identificar os projetos de energia pelo título do projeto, que é um atributo que esperávamos que não fosse alterado na fonte encontramos algumas especificações.

A primeira delas é que um vetor extra de espaços no final do atributo título da tabela dm_projeto. Após removermos esses vetores extras apenas 25 projetos ficam sem correspondência.

```{r}
dm_projeto_sel <- left_join(tbl_dm_projeto, tbl_ft_dispendio[,c("id_item","id_formnt")]) %>%
  filter(id_formnt == 6) %>%
  mutate(título = abjutils::rm_accent(título),
         título = stringr::str_trim(título)) %>%
  unique()
```

A segunda é que dentro do atributo descricao_do_projeto do dataset utilizado para fazer a primeira carga do projeto temos a presença de aspas quadruplas, ou seja ao invés de um termo ser inserido com aspas normais "termo", nesse atributo ele seria escrito assim ""termo"" impedindo que o termo seja identificado pelo título.

```{r}
bndes_ebp1 <- readr::read_delim(here::here("analise algoritmo/bases 1 versao ebp/6.bndes.csv"),
                                delim = ";", escape_double = FALSE, locale = readr::locale(),
                                trim_ws = TRUE, skip = 4) %>%
  janitor::clean_names() %>%
  rename_with(
    .fn = ~str_glue("{.x}_2019")
  ) %>%
  mutate(numero_do_contrato_2019 = as.character(numero_do_contrato_2019),
         descricao_do_projeto_2019 = abjutils::rm_accent(descricao_do_projeto_2019),
         descricao_do_projeto_2019 = stringr::str_replace_all(descricao_do_projeto_2019, '""', '"'))
```

Após corrigirmos os atributos conseguimos identificar todos os casos inseridos no SQLite na base utilizada para fazer a carga em 2019.
```{r, message=TRUE}
bndes_energia_sqlite <- tidylog::semi_join(dm_projeto_sel, bndes_ebp1,
                                            by =c("título" = "descricao_do_projeto_2019"  ))%>% unique()
```

Em seguida procuramos identificar se dentro dos projetos de energia existe algum que não está presente no dataset utilizado para fazer a carga em 2021. 

```{r, message=TRUE}
bndes_brutos <- readxl::read_excel(here::here("data/BNDES/naoautomaticas.xlsx"),
                                   skip = 4) %>%
  janitor::clean_names() %>%
  rename_with(
    .fn = ~str_glue("{.x}_2021")
  ) %>%
  mutate(
    descricao_do_projeto_2021 = abjutils::rm_accent(descricao_do_projeto_2021)
  )

comparacao <- tidylog::full_join(bndes_energia_sqlite, bndes_brutos,
                                 by = c("título" = "descricao_do_projeto_2021"),
                                 keep = TRUE)
```

Identificamos 2 projetos que estão contidos na plataforma INOVA-E, mas não se encontram no dataset disponibilizado no site do BNDES, que está sendo utilizado para fazer a carga nessa versão.

```{r, message=TRUE}

projetos_inexistentes <- bndes_energia_sqlite %>%
  tidylog::anti_join(bndes_brutos,
                     by = c("título" = "descricao_do_projeto_2021"),
                     keep = TRUE)
```

Após olharmos com mais cuidados os casos que não foram encontrados percebemos que houve uma alteração no título do projeto na base que foi utilizada para fazer a carga em 2021. Já que a ausência de um espaço após uma palavra causa a diferença, conforme demonstramos a seguir.

Vemos abaixo os projetos de energia da Plataforma INOVA-E que não foi encontrado na base utilizada para fazer a carga em 2021.

```{r}
reactable::reactable(projetos_inexistentes)
```

Ao ler o atríbuto descricao_do_projeto_2021 observamos que o atributo junta as palavras "UNIDADEDE", que no dataset utilizado para fazer a carga dem 2021 e no sqlite o termo utilizado é "UNIDADE DE", causando assim a diferença.

```{r}
bndes_brutos %>% filter(numero_do_contrato_2021 == 13207061) %>% select(
  numero_do_contrato_2021, descricao_do_projeto_2021
) %>% 
  reactable::reactable()
```



### Análise da classificação das categorias

Dentro dos projetos de energia que foram classificados nas bases intermediárias encontramos as seguintes classificações de IEA.

```{r}
bndes %>%  select(id,categorias) %>%
  rowwise() %>%
  mutate(categorias_split = str_split(categorias, pattern = ",")) %>%
  ungroup() %>% unnest(categorias_split_un =categorias_split) %>% 
  mutate(categorias_split_un = str_remove_all(categorias_split_un, '\\"'),
         categorias_split_un = str_remove_all(categorias_split_un, ' ')) %>% 
  mutate(categorias_rec = recode(categorias_split_un,
                                 `1.1` = "1 Eficiência Energética",
                                 `1.4` = "1 Eficiência Energética",
                                 `2.1` = "2 Energias Fósseis",
                                 `2.2` = "2 Energias Fósseis",
                                 `3.1` = "3 Fontes de Energia Renováveis",
                                 `3.2` = "3 Fontes de Energia Renováveis",
                                 `3.3` = "3 Fontes de Energia Renováveis",
                                 `3.4` = "3 Fontes de Energia Renováveis",
                                 `3.5` = "3 Fontes de Energia Renováveis",
                                 `3.6` = "3 Fontes de Energia Renováveis",
                                 `3.7` = "3 Fontes de Energia Renováveis",
                                 `3.9` = "3 Fontes de Energia Renováveis",
                                 `4.1` = "4 Fissão e Fusão Nuclear",
                                 `5.1` = "5 Hidrogenio e Celulas de Combustível",
                                 `5.2` = "5 Hidrogenio e Celulas de Combustível",
                                 `6.2` = "6 Outras Tecnologias Elétricas e de Armazaenamento",
                                 `6.3` = "6 Outras Tecnologias Elétricas e de Armazaenamento",
                                 `7.1` = "7 Outras Tecnologias Transversais",
                                 "nenhumacategoriaencontrada" = "nenhuma categoria encontrada")) %>% 
  pull(categorias_rec) %>% janitor::tabyl()
```

Na tabela abaixo vemos os resultados quando discriminados por categorias de digito 2.

```{r}
bndes %>%
  select(id,categorias) %>%
  rowwise() %>%
  mutate(categorias_split = str_split(categorias, pattern = ",")) %>%
  ungroup() %>% unnest(categorias_split_un =categorias_split) %>% 
  mutate(categorias_split_un = str_remove_all(categorias_split_un, '\\"'),
         categorias_split_un = str_remove_all(categorias_split_un, ' ')) %>% 
  mutate(categorias_rec = recode(categorias_split_un,
                                 `1.1` = "1.1 Tecnologias de Eficiência Energética Aplicadas a Indústria",
                                 `1.4`= "1.4 Outras Tecnologias de Eficiência Energética",
                                 `2.1` = "2.1 Petróleo e Gás Natural",
                                 `2.2` = "2.2 Carvão Mineral",
                                 `3.1` = "3.1 Energia Solar",
                                 `3.2` = "3.2 Energia Eólica",
                                 `3.3` = "3.3 Energia dos Oceanos",
                                 `3.4` = "3.4 Biocombustíveis",
                                 `3.5` = "3.5 ENergia Geotérmica",
                                 `3.6` = "3.6 Hidroeletricidade",
                                 `3.7` = "3.7 Outras energias Renováveis",
                                 `4.1` = "4.1 Fissão Nuclear",
                                 `5.1` = "5.1 Hidrogenio",
                                 `5.2` = "5.2 Celulas de Combustível",
                                 `6.2` = "6.2 Transmissão e Distribuição",
                                 `6.3` = "6.3 Armazenamento",
                                 `7.1` = "7.1 Análise de Sistemas Energéticos",
                                 "nenhumacategoriaencontrada" = "nenhuma categoria encontrada")) %>% 
  pull(categorias_rec) %>% 
  janitor::tabyl()
```

Já quando analisamos sem considerar os projetos que foram classificados em mais de uma categoria de energia encontramos o seguinte resultado. 

```{r}
bndes %>% filter(categorias %in% c("1.1", "1.2","1.3",
                                   "1.4",
                                   "2.1","2.2","2.3",
                                   "3.1","3.2","3.3",
                                   "3.4","3.5","3.6",
                                   "3.7",
                                   "4.1","4.2",
                                   "5.1","5.2",
                                   "6.1","6.2","6.3",
                                   "7.1","7.2", "nenhuma categoria encontrada")) %>%
  mutate(categorias_rec = recode(categorias,
                                 `1.1` = "1 Eficiência Energética",
                                 `1.4`= "1 Eficiência Energética",
                                 `2.1` = "2 Energias Fósseis",
                                 `2.2` = "2 Energias Fósseis",
                                 `3.1` = "3 Fontes de Energia Renováveis",
                                 `3.2` = "3 Fontes de Energia Renováveis",
                                 `3.3` = "3 Fontes de Energia Renováveis",
                                 `3.4` = "3 Fontes de Energia Renováveis",
                                 `3.5` = "3 Fontes de Energia Renováveis",
                                 `3.6` = "3 Fontes de Energia Renováveis",
                                 `3.7` = "3 Fontes de Energia Renováveis",
                                 `4.1` = "4 Fissão e Fusão Nuclear",
                                 `5.1` = "5 Hidrogenio e Celulas de Combustível",
                                 `5.2` = "5 Hidrogenio e Celulas de Combustível",
                                 `6.2` = "6 Outras Tecnologias Elétricas e de Armazaenamento",
                                 `6.3` = "6 Outras Tecnologias Elétricas e de Armazaenamento",
                                 `7.1` = "7 Outras Tecnologias Transversais")) %>% 
  pull(categorias_rec) %>% 
  janitor::tabyl()
```

Na tabela abaixo vemos os resultados quando discriminados por categorias de digito 2.

```{r}
bndes %>%
  filter(categorias %in% c("1.1", "1.2","1.3",
                           "1.4",
                           "2.1","2.2","2.3",
                           "3.1","3.2","3.3",
                           "3.4","3.5","3.6",
                           "3.7",
                           "4.1","4.2",
                           "5.1","5.2",
                           "6.1","6.2","6.3",
                           "7.1","7.2", "nenhuma categoria encontrada")) %>%
  mutate(categorias_rec = recode(categorias,
                                 `1.1` = "1.1 Tecnologias de Eficiência Energética Aplicadas a Indústria",
                                 `1.4`= "1.4 Outras Tecnologias de Eficiência Energética",
                                 `2.1` = "2.1 Petróleo e Gás Natural",
                                 `2.2` = "2.2 Carvão Mineral",
                                 `3.1` = "3.1 Energia Solar",
                                 `3.2` = "3.2 Energia Eólica",
                                 `3.3` = "3.3 Energia dos Oceanos",
                                 `3.4` = "3.4 Biocombustíveis",
                                 `3.5` = "3.5 ENergia Geotérmica",
                                 `3.6` = "3.6 Hidroeletricidade",
                                 `3.7` = "3.7 Outras energias Renováveis",
                                 `4.1` = "4.1 Fissão Nuclear",
                                 `5.1` = "5.1 Hidrogenio",
                                 `5.2` = "5.2 Celulas de Combustível",
                                 `6.2` = "6.2 Transmissão e Distribuição",
                                 `6.3` = "6.3 Armazenamento",
                                 `7.1` = "7.1 Análise de Sistemas Energéticos")) %>% 
  pull(categorias_rec) %>% 
  janitor::tabyl()
```

## CNEN

Já para a CNEN temos apenas um caso no SQLite, que é um caso que agrega os investimentos da CNEN no período. Esse caso agregado não pode ser encontrado no dataset intermediário.

```{r}
#Apenas 1 caso oriunda da CNEN
dm_cnen <- dm_proj_dispendio %>% filter(id_formnt == 12)

cnen <- cria_base_intermediaria_cnen()

origem_processos = here::here("data/CNEN/Projeto CNEN_Plataforma Inova-E.xlsx")

#importando base de dados bruta
cnen_org <- readxl::read_excel(origem_processos,
                     col_types = c("text", "text", "text",
                                   "text", "date", "date", "text", "numeric",
                                   "text", "text", "text", "text", "text",
                                   "text", "text", "text", "text", "text")) %>%
    janitor::clean_names() %>%
    dplyr::slice(-c(1,2,3))

#Checando os projetos no banco de dados tratado

#nenhum caso encontrado pelo id
comparacao_cnen_id <- tidylog::full_join(dm_cnen, cnen, suffix = c("_dm_cnen", "_base_tratada"),
                    by = c("id_item" = "id"), keep = TRUE)
```

Nem na base bruto.

```{r, message = TRUE}

#nenhum caso encontrado pelo título do projeto
comparacao_cnen <- tidylog::full_join(dm_cnen, cnen, suffix = c("_dm_cnen", "_base_tratada"),
                    by = c("título" = "titulo_projeto"), keep = TRUE)

sobra_dm_cnen <- comparacao_cnen %>% filter(is.na(id))


```

Para a CNEN não fora encontrado dataset original.

## CNPQ

```{r}

```


## FINEP

Para os projetos de energia oriundos da FINEP, fora utilizado o dataset "14_09_2021_Liberacoes.ods", que é disponibilizado no site da fonte. Para essa fonte removemos todos os projetos com prazo de utilização inferior a data 01/01/2013 e com valores de financiamento omissos.

Temos 32 casos no dataset INOVA-E oriundos da FINEP.
```{r}
dm_finep <- dm_proj_dispendio %>% filter(id_formnt == 7)

finep <- cria_base_intermediaria_finep()

finep <- finep %>% tibble() %>%  mutate(id = str_remove(id, "FINEP-"))

#importando base de dados bruta
origem_processos = here::here("data/FINEP/14_09_2021_Liberacoes.ods")

finep_org <- readODS::read_ods(path = origem_processos,
                    skip = 4,
                    sheet = 1)

names(finep_org)<-finep_org[1,]

finep_org <- finep_org %>% janitor::clean_names()%>% dplyr::slice(-1)
```

Desses 32 casos apenas 2 não foram encontrados no dataset intermediário, quando utilizamos o atributo id do projeto.

```{r}
# 2 linhas apenas em dm_finep
# 95 Matched rows
comparacao_finep_id <- tidylog::full_join(dm_finep, finep, suffix = c("_dm_finep", "_base_tratada"),
                    by = c("id_item" = "id"), keep = TRUE)
```

Já quando usamos o título do projeto encontramos 3 casos que existem apenas no dataset INOVA-E.

```{r}
# 3 linhas apenas em dm_finep
#93 matched rows
comparacao_finep <- tidylog::full_join(dm_finep, finep, suffix = c("_dm_finep", "_base_tratada"),
                    by = c("título" = "titulo_projeto"), keep = TRUE)
```

Decidimos checar a existência dos casos no dataset bruto.
Todos os casos que não existem no dataset tratado existem no dataset bruto.

```{r}
#dataset com todos os casos que existem no SQLite da inova-E 
#mas que não tem correspondência na base tratada
sobra_dm_finep <-  comparacao_finep_id %>% filter(is.na(id))

#utilizando a base bruta
#8 matched rows
comparacao_finep_org_id <- tidylog::inner_join(sobra_dm_finep, finep_org, 
                                     by = c("id_item" = "contrato"))%>%
                          select(título,
                          id_item,
                          cat2,
                          valor_finep,
                          status,
                          vlr)
```
Seguem os projetos que não foram identificados no banco de dados tratado.

```{r}
reactable::reactable(sobra_dm_finep)
```

Quando utilizamos o atributo título do projeto também nos é retornado os mesmo 8 projetos.

```{r}
#8 matched rows
comparacao_finep_org <- tidylog::inner_join(sobra_dm_finep, finep_org, 
                                     by = c("título" = "titulo")) %>% 
                        select(título,
                          id_item,
                          cat2,
                          valor_finep,
                          status,
                          vlr)
```
A saber seguem os projetos que não foram identificados no dataset tratado mas existem no dataset original.

```{r}
reactable::reactable(comparacao_finep_org)
```

Quando verificamos com o dataset original também encontramos esses casos .

```{r}
#fazendo a analise com os casos importados na 1° carga do SQLite

finep_ebp <- read_delim(here::here("analise algoritmo/bases 1 versao ebp/2.FINEP.csv"), 
    delim = ";", escape_double = FALSE, trim_ws = TRUE, 
    skip = 5) %>% janitor::clean_names()

#8 matched rows
comparacao_finep_ebp_id <- tidylog::inner_join(sobra_dm_finep, finep_ebp, 
                                     by = c("id_item" = "contrato"))%>%
                          select(título,
                          id_item,
                          cat2,
                          valor_finep,
                          status,
                          vlr)
```


```{r}
#8 matched rows
comparacao_finep_ebp <- tidylog::inner_join(sobra_dm_finep, finep_ebp, 
                                     by = c("título" = "titulo")) %>% 
                        select(título,
                          id_item,
                          cat2,
                          valor_finep,
                          status,
                          vlr)
```

Projetos de Energia encontrados na base original.

```{r}
reactable::reactable(comparacao_finep_ebp)
```

Para o caso foram encontrados 2 projetos de energia que não foram encontrados devemos investigar o código do tratamento, afim de identificar o porquê dos casos serem excluídos.

```{r}
#todos os 32 projetos de energia encontrados no SQLite tem retorno no banco de dados original
check_finep <- tidylog::full_join(dm_finep, finep_ebp, suffix = c("_dm_bndes", "_base_ebp"),
                    by = c("id_item" = "contrato"), keep = TRUE)

```

### Análise da classificação das categorias

Dentro dos projetos de energia que foram classificados nas bases intermediárias encontramos as seguintes classificações de IEA.

```{r}
finep %>%  select(id,categorias) %>%
  rowwise() %>%
  mutate(categorias_split = str_split(categorias, pattern = ",")) %>%
  ungroup() %>% unnest(categorias_split_un =categorias_split) %>% 
  mutate(categorias_split_un = str_remove_all(categorias_split_un, '\\"'),
         categorias_split_un = str_remove_all(categorias_split_un, ' ')) %>% 
  mutate(categorias_rec = recode(categorias_split_un,
                                 `1.1` = "1 Eficiência Energética",
                                 `1.4` = "1 Eficiência Energética",
                                 `2.1` = "2 Energias Fósseis",
                                 `2.2` = "2 Energias Fósseis",
                                 `3.1` = "3 Fontes de Energia Renováveis",
                                 `3.2` = "3 Fontes de Energia Renováveis",
                                 `3.3` = "3 Fontes de Energia Renováveis",
                                 `3.4` = "3 Fontes de Energia Renováveis",
                                 `3.5` = "3 Fontes de Energia Renováveis",
                                 `3.6` = "3 Fontes de Energia Renováveis",
                                 `3.7` = "3 Fontes de Energia Renováveis",
                                 `3.9` = "3 Fontes de Energia Renováveis",
                                 `4.1` = "4 Fissão e Fusão Nuclear",
                                 `5.1` = "5 Hidrogenio e Celulas de Combustível",
                                 `5.2` = "5 Hidrogenio e Celulas de Combustível",
                                 `6.2` = "6 Outras Tecnologias Elétricas e de Armazaenamento",
                                 `6.3` = "6 Outras Tecnologias Elétricas e de Armazaenamento",
                                 `7.1` = "7 Outras Tecnologias Transversais",
                                 "nenhumacategoriaencontrada" = "nenhuma categoria encontrada")) %>% 
  pull(categorias_rec) %>% janitor::tabyl()

```

Na tabela abaixo vemos os resultados quando discriminados por categorias de digito 2.

```{r}

finep %>%
  select(id,categorias) %>%
  rowwise() %>%
  mutate(categorias_split = str_split(categorias, pattern = ",")) %>%
  ungroup() %>% unnest(categorias_split_un =categorias_split) %>% 
  mutate(categorias_split_un = str_remove_all(categorias_split_un, '\\"'),
         categorias_split_un = str_remove_all(categorias_split_un, ' ')) %>% 
  mutate(categorias_rec = recode(categorias_split_un,
                                 `1.1` = "1.1 Tecnologias de Eficiência Energética Aplicadas a Indústria",
                                 `1.4`= "1.4 Outras Tecnologias de Eficiência Energética",
                                 `2.1` = "2.1 Petróleo e Gás Natural",
                                 `2.2` = "2.2 Carvão Mineral",
                                 `3.1` = "3.1 Energia Solar",
                                 `3.2` = "3.2 Energia Eólica",
                                 `3.3` = "3.3 Energia dos Oceanos",
                                 `3.4` = "3.4 Biocombustíveis",
                                 `3.5` = "3.5 ENergia Geotérmica",
                                 `3.6` = "3.6 Hidroeletricidade",
                                 `3.7` = "3.7 Outras energias Renováveis",
                                 `4.1` = "4.1 Fissão Nuclear",
                                 `5.1` = "5.1 Hidrogenio",
                                 `5.2` = "5.2 Celulas de Combustível",
                                 `6.2` = "6.2 Transmissão e Distribuição",
                                 `6.3` = "6.3 Armazenamento",
                                 `7.1` = "7.1 Análise de Sistemas Energéticos",
                                 "nenhumacategoriaencontrada" = "nenhuma categoria encontrada")) %>% 
  pull(categorias_rec) %>% 
  janitor::tabyl()
```

Já quando analisamos sem considerar os projetos que foram classificados em mais de uma categoria de energia encontramos o seguinte resultado. 

```{r}


finep %>% filter(categorias %in% c("1.1", "1.2","1.3",
                                   "1.4",
                                   "2.1","2.2","2.3",
                                   "3.1","3.2","3.3",
                                   "3.4","3.5","3.6",
                                   "3.7",
                                   "4.1","4.2",
                                   "5.1","5.2",
                                   "6.1","6.2","6.3",
                                   "7.1","7.2", "nenhuma categoria encontrada")) %>%
  mutate(categorias_rec = recode(categorias,
                                 `1.1` = "1 Eficiência Energética",
                                 `1.4`= "1 Eficiência Energética",
                                 `2.1` = "2 Energias Fósseis",
                                 `2.2` = "2 Energias Fósseis",
                                 `3.1` = "3 Fontes de Energia Renováveis",
                                 `3.2` = "3 Fontes de Energia Renováveis",
                                 `3.3` = "3 Fontes de Energia Renováveis",
                                 `3.4` = "3 Fontes de Energia Renováveis",
                                 `3.5` = "3 Fontes de Energia Renováveis",
                                 `3.6` = "3 Fontes de Energia Renováveis",
                                 `3.7` = "3 Fontes de Energia Renováveis",
                                 `4.1` = "4 Fissão e Fusão Nuclear",
                                 `5.1` = "5 Hidrogenio e Celulas de Combustível",
                                 `5.2` = "5 Hidrogenio e Celulas de Combustível",
                                 `6.2` = "6 Outras Tecnologias Elétricas e de Armazaenamento",
                                 `6.3` = "6 Outras Tecnologias Elétricas e de Armazaenamento",
                                 `7.1` = "7 Outras Tecnologias Transversais")) %>% 
  pull(categorias_rec) %>% 
  janitor::tabyl()
```

Na tabela abaixo vemos os resultados quando discriminados por categorias de digito 2.

```{r}


finep %>%
  filter(categorias %in% c("1.1", "1.2","1.3",
                           "1.4",
                           "2.1","2.2","2.3",
                           "3.1","3.2","3.3",
                           "3.4","3.5","3.6",
                           "3.7",
                           "4.1","4.2",
                           "5.1","5.2",
                           "6.1","6.2","6.3",
                           "7.1","7.2", "nenhuma categoria encontrada")) %>%
  mutate(categorias_rec = recode(categorias,
                                 `1.1` = "1.1 Tecnologias de Eficiência Energética Aplicadas a Indústria",
                                 `1.4`= "1.4 Outras Tecnologias de Eficiência Energética",
                                 `2.1` = "2.1 Petróleo e Gás Natural",
                                 `2.2` = "2.2 Carvão Mineral",
                                 `3.1` = "3.1 Energia Solar",
                                 `3.2` = "3.2 Energia Eólica",
                                 `3.3` = "3.3 Energia dos Oceanos",
                                 `3.4` = "3.4 Biocombustíveis",
                                 `3.5` = "3.5 ENergia Geotérmica",
                                 `3.6` = "3.6 Hidroeletricidade",
                                 `3.7` = "3.7 Outras energias Renováveis",
                                 `4.1` = "4.1 Fissão Nuclear",
                                 `5.1` = "5.1 Hidrogenio",
                                 `5.2` = "5.2 Celulas de Combustível",
                                 `6.2` = "6.2 Transmissão e Distribuição",
                                 `6.3` = "6.3 Armazenamento",
                                 `7.1` = "7.1 Análise de Sistemas Energéticos")) %>% 
  pull(categorias_rec) %>% 
  janitor::tabyl()
```


## FAPESP
Para a fonte FAPESP utilizamos o dataset "PROJETOS FAPESP SELECIONADOS INOVA-E - VALORES - 13 dez 2021.xlsx" que fora enviado pela fonte dos dados. 

Para o caso da FAPESP temos 32 projetos de energia no SQLite. 
```{r}
dm_fapesp <- dm_proj_dispendio %>% filter(id_formnt == 7)

fapesp <- cria_base_intermediaria_fapesp()

fapesp <- fapesp %>% tibble() %>%  mutate(id = str_remove(id, "FAPESP-"))

#importando base de dados bruta
origem_processos = here::here("data/FAPESP/PROJETOS FAPESP SELECIONADOS INOVA-E - VALORES - 13 dez 2021.xlsx")

fapesp_org <- readxl::read_excel(origem_processos) %>%
    janitor::clean_names()

```

Ao compararmos os casos com o dataset intermediário não encontramos nenhuma correspondência. 

```{r, message= TRUE}
#juntamos todos os casos da base dm_fapesp e fapesp
#0 Matched Rows
# Nenhum caso encontrado no sqlite é encontrado na base tratada
comparacao_fapesp <- tidylog::full_join(dm_fapesp, fapesp, suffix = c("_dm_fapesp", "_base_tratada"),
                    by = c("id_item" = "id"), keep = TRUE)
```
Decidimos então fazer a comparação dataset bruto. Ainda assim não encontramos qualquer correspondência.

```{r, message= TRUE}


#criamos um dataset com todos os casos que não tem valores na base tratada
sobra_dm_fapesp <- comparacao_fapesp %>% filter(is.na(id))

# comparando os casos que não foram encontrados do sqlite na base tratada
# com os casos que estão na base original
comparacao_fapesp_org <- tidylog::inner_join(sobra_dm_fapesp, fapesp_org, 
                                     by = c("id_item" = "n_processo"))
```

Decidimos então comparar com o dataset original  na primeira versão do projeto

```{r, message= TRUE}

#importando dataset utilizado no ebp
fapesp_ebp <- read_delim(here::here("analise algoritmo/bases 1 versao ebp/7.FAPESP_energia.csv"), 
    delim = ";", escape_double = FALSE, trim_ws = TRUE) %>% janitor::clean_names()


# comparando os casos que não foram encontrados do sqlite na base tratada
# com os casos usados na base original
comparacao_anp_ebp <- tidylog::inner_join(sobra_dm_fapesp, fapesp_ebp,
                    by = c("id_item" = "n_processo"), keep = TRUE)

```

Ao checarmos se existe correspondência entre o dataset da INOVA-E e o dataset original também não encontramos correspondência alguma. Seja por título de projeto seja por id do projeto.

```{r, message= TRUE}
# checando se os casos do SQlite se encontram  no dataset do ebp1
# nenhum caso encontrado pelo n° do projeto
check_fapesp_id <- tidylog::full_join(dm_fapesp, fapesp_ebp, suffix = c("_dm_fapesp", "_base_ebp"),
                    by = c("id_item" = "n_processo"), keep = TRUE)
```


```{r, message= TRUE}
# nenhum caso encontrado pelo n° do projeto# nenhum caso encontrado pelo título
check_fapesp <- tidylog::full_join(dm_fapesp, fapesp_ebp, suffix = c("_dm_fapesp", "_base_ebp"),
                    by = c("título" = "titulo_portugues"), keep = TRUE)
```


# Validação Algoritmo

## Aneel

Consideramos que projetos classificados em mais de uma categoria de nivel 1 serão classificados na subseção 9


```{r}
comparacao_org <- comparacao_org %>% mutate(motor                         = tolower(stringi::stri_trans_general(paste(titulo,segmento,tema),
                                                                "Latin-ASCII")))
comparacao_org_sel <- comparacao_org %>% select(id_item,
                                                titulo,
                                                cat2,
                          custo_total_previsto,
                          custo_total_realizado,
                          situacao,
                          vlr, motor)

comparacao_org_sel <- dtc_categorias(df = comparacao_org_sel, processo = id_item,
               motor =motor) 

comparacao_org_sel <- comparacao_org_sel %>% 
  dplyr::mutate(categorias = dplyr::recode(categorias,
                                                        "character(0" = "nenhuma categoria encontrada"))

comparacao_org_sel2 <- comparacao_org_sel %>% rowwise() %>%
  mutate(categorias_split = str_split(categorias, pattern = ",")) %>%
  ungroup() %>% unnest(categorias_split_un =categorias_split) %>% 
  mutate(categorias_split_un = str_remove_all(categorias_split_un, '\\"')) %>%
  mutate(correto = categorias_split_un == cat2 ) %>% group_by(id_item) %>%
  summarise(correto = mean(correto))

grau_acerto <- mean(comparacao_org_sel2$correto)
```

 
